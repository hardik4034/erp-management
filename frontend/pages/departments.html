<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Departments - HRMS</title>
    <link rel="icon" type="image/png" href="../assets/logo.png">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/toast.css">
    <link rel="stylesheet" href="../styles/role-selector.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../assets/logo.png" alt="Soleos Logo" class="sidebar-logo">
                <button class="sidebar-close-btn" id="sidebarClose">&times;</button>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item"><a href="../index.html" class="nav-link"><i>üìä</i> Dashboard</a></div>
                <div class="nav-item"><a href="employees.html" class="nav-link"><i>üë•</i> Employees</a></div>
                <div class="nav-item"><a href="attendance.html" class="nav-link"><i>üìÖ</i> Attendance</a></div>
                <div class="nav-item"><a href="leaves.html" class="nav-link"><i>üèñÔ∏è</i> Leaves</a></div>
                <div class="nav-item"><a href="holidays.html" class="nav-link"><i>üéâ</i> Holidays</a></div>
                <div class="nav-item"><a href="payroll.html" class="nav-link"><i>üí∞</i> Payroll</a></div>
                <div class="nav-item"><a href="employee-salary.html" class="nav-link"><i>üíµ</i> Employee Salary</a></div>
                <div class="nav-item"><a href="departments.html" class="nav-link active"><i>üè¢</i> Departments</a></div>
                <div class="nav-item"><a href="designations.html" class="nav-link"><i>üíº</i> Designations</a></div>
                <div class="nav-item"><a href="appreciations.html" class="nav-link"><i>üèÜ</i> Appreciations</a></div>
                <div class="nav-item"><a href="note.html" class="nav-link"><i>üìù</i> Note</a></div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="hamburger-btn" id="sidebarToggle">
                        ‚ò∞
                    </button>
                    <div class="header-title"><h1>Department Management</h1></div>
                </div>
                <div class="header-actions">
                    <div class="role-selector">
                        <label for="roleDropdown">Current Role:</label>
                        <select id="roleDropdown">
                            <option value="admin">Admin</option>
                            <option value="hr">HR</option>
                            <option value="manager">Manager</option>
                            <option value="employee">Employee</option>
                        </select>
                    </div>
                    <span class="role-badge" id="roleBadge">Employee</span>
                </div>
            </header>

            <div class="content-area">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Departments</h3>
                        <button class="btn btn-primary admin-only create-btn" onclick="openAddModal()" id="addBtn">+ Add Department</button>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Department Name</th>
                                    <th>Description</th>
                                    <th>Employee Count</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="departmentsTable">
                                <tr><td colspan="5" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal" id="departmentModal">
        <div class="modal-content" style="max-width: 1000px; width: 90%;">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add Department</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="departmentForm">
                    <input type="hidden" id="departmentId">
                    <div class="form-group">
                        <label class="form-label">Department Name *</label>
                        <input type="text" id="departmentName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="description" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveDepartment()">Save</button>
            </div>
        </div>
    </div>

    <script src="../scripts/toast.js"></script>
    <script src="../scripts/sidebar.js"></script>
    <script src="../scripts/role-manager.js"></script>
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/api.js"></script>
    <script>
        auth.requireAuth();
        auth.initAuth();

        let departments = [];
        const canManage = auth.hasRole('Admin', 'HR');
        
        if (!canManage) {
            document.getElementById('addBtn').style.display = 'none';
        }

        async function loadDepartments() {
            try {
                const response = await endpoints.departments.getAll();
                departments = response.data || [];
                renderTable();
            } catch (error) {
                console.error('Error loading departments:', error);
                utils.showAlert('Failed to load departments', 'error');
            }
        }

        function renderTable() {
            const tbody = document.getElementById('departmentsTable');
            if (departments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No departments found</td></tr>';
                return;
            }

            tbody.innerHTML = departments.map(dept => `
                <tr>
                    <td><strong>${dept.DepartmentName}</strong></td>
                    <td>${dept.Description || '-'}</td>
                    <td><span class="badge badge-info">${dept.EmployeeCount || 0} employees</span></td>
                    <td><span class="badge badge-success">${dept.Status}</span></td>
                    <td>
                        ${canManage ? `
                            <button class="btn btn-sm btn-outline" onclick="editDepartment(${dept.DepartmentId})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteDepartment(${dept.DepartmentId})">Delete</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add Department';
            document.getElementById('departmentForm').reset();
            document.getElementById('departmentId').value = '';
            document.getElementById('departmentModal').classList.add('active');
        }

        async function editDepartment(id) {
            const dept = departments.find(d => d.DepartmentId === id);
            if (!dept) return;

            document.getElementById('modalTitle').textContent = 'Edit Department';
            document.getElementById('departmentId').value = dept.DepartmentId;
            document.getElementById('departmentName').value = dept.DepartmentName;
            document.getElementById('description').value = dept.Description || '';
            document.getElementById('departmentModal').classList.add('active');
        }

        async function saveDepartment() {
            const form = document.getElementById('departmentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const id = document.getElementById('departmentId').value;
            const data = {
                departmentName: document.getElementById('departmentName').value,
                description: document.getElementById('description').value || null
            };

            try {
                if (id) {
                    await endpoints.departments.update(id, data);
                    utils.showAlert('Department updated successfully', 'success');
                } else {
                    await endpoints.departments.create(data);
                    utils.showAlert('Department created successfully', 'success');
                }
                closeModal();
                loadDepartments();
            } catch (error) {
                console.error('Error saving department:', error);
                utils.showAlert(error.message || 'Failed to save department', 'error');
            }
        }

        async function deleteDepartment(id) {
            if (!confirm('Are you sure you want to delete this department?')) return;
            try {
                await endpoints.departments.delete(id);
                utils.showAlert('Department deleted successfully', 'success');
                loadDepartments();
            } catch (error) {
                console.error('Error deleting department:', error);
                utils.showAlert('Failed to delete department', 'error');
            }
        }

        function closeModal() {
            document.getElementById('departmentModal').classList.remove('active');
        }

        loadDepartments();
    </script>
</body>
</html>
