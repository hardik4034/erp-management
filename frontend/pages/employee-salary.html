<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Salary - HRMS</title>
    <link rel="icon" type="image/png" href="../assets/logo.png">
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/toast.css">
    <link rel="stylesheet" href="../styles/role-selector.css">
    <style>
        .salary-table-container {
            overflow-x: auto;
        }
        
        .salary-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .salary-table th,
        .salary-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .salary-table th {
            background-color: #f5f5f5;
            font-weight: 600;
            font-size: 14px;
        }
        
        .employee-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .employee-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .employee-details {
            display: flex;
            flex-direction: column;
        }
        
        .employee-name {
            font-weight: 500;
            font-size: 14px;
        }
        
        .employee-designation {
            font-size: 12px;
            color: #888;
        }
        
        .inline-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            min-width: 120px;
        }
        
        .inline-input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            width: 120px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #2196F3;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        .add-salary-btn {
            background: none;
            border: none;
            color: #2196F3;
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
        }
        
        .add-salary-btn:hover {
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        /* Role Badge in Modal */
        .role-badge-small {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: capitalize;
            letter-spacing: 0.3px;
        }

        .role-badge-small.admin {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .role-badge-small.hr {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .role-badge-small.manager {
            background-color: #fef3c7;
            color: #92400e;
        }

        .role-badge-small.employee {
            background-color: #d1fae5;
            color: #065f46;
        }

        /* Hide sidebar and header when in iframe */
        body.in-iframe .sidebar,
        body.in-iframe .sidebar-overlay,
        body.in-iframe .header {
            display: none !important;
        }

        body.in-iframe .main-content {
            margin-left: 0 !important;
            width: 100% !important;
        }

        body.in-iframe .content-area {
            padding-top: 0 !important;
        }
    </style>
    <script>
        // Detect if page is loaded in iframe
        if (window.self !== window.top) {
            document.addEventListener('DOMContentLoaded', function() {
                document.body.classList.add('in-iframe');
            });
        }
    </script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../assets/logo.png" alt="Soleos Logo" class="sidebar-logo">
                <button class="sidebar-close-btn" id="sidebarClose">&times;</button>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item">
                    <a href="../index.html" class="nav-link">
                        <i>üìä</i> Dashboard
                    </a>
                </div>
                <div class="nav-item">
                    <a href="employees.html" class="nav-link">
                        <i>üë•</i> Employees
                    </a>
                </div>
                <div class="nav-item">
                    <a href="attendance.html" class="nav-link">
                        <i>üìÖ</i> Attendance
                    </a>
                </div>
                <div class="nav-item">
                    <a href="leaves.html" class="nav-link">
                        <i>üèñÔ∏è</i> Leaves
                    </a>
                </div>
                <div class="nav-item">
                    <a href="holidays.html" class="nav-link">
                        <i>üéâ</i> Holidays
                    </a>
                </div>
                <div class="nav-item">
                    <a href="payroll.html" class="nav-link">
                        <i>üí∞</i> Payroll
                    </a>
                </div>
                <div class="nav-item">
                    <a href="employee-salary.html" class="nav-link active">
                        <i>üíµ</i> Employee Salary
                    </a>
                </div>
                <div class="nav-item">
                    <a href="departments.html" class="nav-link">
                        <i>üè¢</i> Departments
                    </a>
                </div>
                <div class="nav-item">
                    <a href="designations.html" class="nav-link">
                        <i>üíº</i> Designations
                    </a>
                </div>
                <div class="nav-item">
                    <a href="appreciations.html" class="nav-link">
                        <i>üèÜ</i> Appreciations
                    </a>
                </div>

                <div class="nav-item">
                    <a href = "note.html" class="nav-link">
                        <i>üìù</i> Note
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="hamburger-btn" id="sidebarToggle">
                        ‚ò∞
                    </button>
                    <div class="header-title"><h1>Employee Salary</h1></div>
                </div>
                <div class="header-actions">
                    <div class="role-selector">
                        <label for="roleDropdown">Current Role:</label>
                        <select id="roleDropdown">
                            <option value="admin">Admin</option>
                            <option value="hr">HR</option>
                            <option value="manager">Manager</option>
                            <option value="employee">Employee</option>
                        </select>
                    </div>
                    <span class="role-badge" id="roleBadge">Employee</span>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Employee Salary Configuration</h3>
                        <button class="btn btn-outline" onclick="exportSalaries()">
                            üì§ Export
                        </button>
                    </div>

                    <!-- Filters -->
                    <div class="filter-bar">
                        <div class="filter-group">
                            <label>Designation</label>
                            <select id="filterDesignation" class="inline-select" onchange="applyFilters()">
                                <option value="">All</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Department</label>
                            <select id="filterDepartment" class="inline-select" onchange="applyFilters()">
                                <option value="">All</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Search</label>
                            <input type="text" id="searchBox" class="inline-input" placeholder="Start typing to search" oninput="applyFilters()">
                        </div>
                    </div>

                    <!-- Salary Table -->
                    <div class="salary-table-container">
                        <table class="salary-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Employee Salary Cycle</th>
                                    <th>Salary Group</th>
                                    <th>Allow Payroll Generate</th>
                                    <th>Net Salary (Monthly)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="salaryTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Salary Modal -->
    <div class="modal" id="salaryModal">
        <div class="modal-content" style="max-width: 1500px; width: 95%;">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add Salary</h3>
                <button class="modal-close" onclick="closeSalaryModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 30px;">
                <form id="salaryForm">
                    <input type="hidden" id="employeeSalaryId">
                    <input type="hidden" id="modalEmployeeId">

                    <!-- Employee Selection with Avatar -->
                    <div class="form-group" style="margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                            <div id="modalEmployeeAvatar" class="employee-avatar" style="width: 48px; height: 48px; font-size: 18px;">
                                RL
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                                    <div id="modalEmployeeName" style="font-weight: 600; font-size: 16px;">
                                        Roselyn Lehner
                                    </div>
                                    <span id="modalEmployeeRole" class="role-badge-small employee">
                                        Employee
                                    </span>
                                </div>
                                <div id="modalEmployeeDesignation" style="font-size: 13px; color: #888;">
                                    UI/UX Designer
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Annual CTC -->
                    <div class="form-group" style="margin-bottom: 30px;">
                        <label class="form-label" style="font-weight: 600; margin-bottom: 8px; display: block;">
                            Annual CTC <span style="color: #e74c3c;">*</span>
                        </label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #666; font-weight: 500;">$</span>
                            <input type="number" id="annualCTC" class="form-control" 
                                   style="padding-left: 28px; font-size: 16px; font-weight: 500;" 
                                   placeholder="0.00" step="0.01" required
                                   oninput="calculateSalaryComponents()">
                        </div>
                        <div style="margin-top: 8px; font-size: 13px; color: #666;">
                            (Cost to company value for the whole year)
                        </div>
                    </div>

                    <!-- Salary Component Section -->
                    <div style="margin-bottom: 25px;">
                        

                        <!-- Salary Components Table -->
                        <div style="border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; border-bottom: 1px solid #e0e0e0;">
                                            Salary Component
                                        </th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; border-bottom: 1px solid #e0e0e0; width: 200px;">
                                            Calculation Type
                                        </th>
                                        <th style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600; border-bottom: 1px solid #e0e0e0; width: 150px;">
                                            Monthly Amount
                                        </th>
                                        <th style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600; border-bottom: 1px solid #e0e0e0; width: 150px;">
                                            Annual Amount
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Earnings Section Header -->
                                    <tr style="background: #fafafa;">
                                        <td colspan="4" style="padding: 10px 12px; font-weight: 600; font-size: 14px; border-bottom: 1px solid #e0e0e0;">
                                            Earnings
                                        </td>
                                    </tr>

                                    <!-- Basic Salary -->
                                    <tr>
                                        <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">
                                            <div style="font-weight: 500;">Basic Salary</div>
                                        </td>
                                        <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <input type="number" id="basicSalaryPercent" 
                                                       style="width: 70px; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; text-align: right;"
                                                       value="50" min="0" max="100" step="0.01"
                                                       oninput="calculateSalaryComponents()">
                                                <select style="flex: 1; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                                    <option value="percent">% of CTC</option>
                                                    <option value="fixed">Fixed Amount</option>
                                                </select>
                                            </div>
                                        </td>
                                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e0e0e0;">
                                            <div style="display: flex; align-items: center; justify-content: flex-end; gap: 6px;">
                                                <span style="color: #666;">$</span>
                                                <span id="basicSalaryMonthly" style="font-weight: 500;">0.00</span>
                                            </div>
                                        </td>
                                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e0e0e0;">
                                            <div style="display: flex; align-items: center; justify-content: flex-end; gap: 6px;">
                                                <span style="color: #666;">$</span>
                                                <span id="basicSalaryAnnual" style="font-weight: 500;">0.00</span>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Special Allowance -->
                                    <tr>
                                        <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">
                                            <div style="font-weight: 500;">Special Allowance</div>
                                        </td>
                                        <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">
                                            <select style="width: 100%; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                                <option value="special">Special Allowance</option>
                                                <option value="hra">HRA</option>
                                                <option value="transport">Transport Allowance</option>
                                            </select>
                                        </td>
                                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e0e0e0;">
                                            <div style="display: flex; align-items: center; justify-content: flex-end; gap: 6px;">
                                                <span style="color: #666;">$</span>
                                                <span id="specialAllowanceMonthly" style="font-weight: 500;">0.00</span>
                                            </div>
                                        </td>
                                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e0e0e0;">
                                            <div style="display: flex; align-items: center; justify-content: flex-end; gap: 6px;">
                                                <span style="color: #666;">$</span>
                                                <span id="specialAllowanceAnnual" style="font-weight: 500;">0.00</span>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Additional Components Note -->
                                    <tr>
                                        <td colspan="4" style="padding: 12px; text-align: center; color: #888; font-size: 13px; font-style: italic;">
                                            (Annual CTC = Sum of all other components)
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Cost To Company Summary -->
                    <div style="background: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 8px; padding: 20px; margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 6px;">Cost To Company</div>
                                <div style="font-size: 24px; font-weight: 700; color: #2c3e50;">
                                    <span style="font-size: 18px; color: #666;">$</span>
                                    <span id="totalCostMonthly">0.00</span>
                                </div>
                                <div style="font-size: 12px; color: #888; margin-top: 4px;">Monthly</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 6px;">Annual CTC</div>
                                <div style="font-size: 24px; font-weight: 700; color: #2c3e50;">
                                    <span style="font-size: 18px; color: #666;">$</span>
                                    <span id="totalCostAnnual">0.00</span>
                                </div>
                                <div style="font-size: 12px; color: #888; margin-top: 4px;">Per Year</div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Fields (Hidden but available for backend) -->
                    <input type="hidden" id="baseSalary">
                    <input type="hidden" id="salaryCycle" value="Monthly">
                    <input type="hidden" id="currency" value="USD">
                    <input type="hidden" id="netSalaryMonthly">
                    <input type="hidden" id="effectiveFrom">
                    <input type="hidden" id="salaryGroup">
                    <input type="hidden" id="allowPayrollGenerate" value="true">
                </form>
            </div>
            <div class="modal-footer" style="padding: 20px 30px; background: #f9f9f9;">
                <button class="btn btn-primary" onclick="saveSalary()" style="min-width: 100px; padding: 10px 24px;">
                    ‚úì Save
                </button>
                <button class="btn btn-outline" onclick="closeSalaryModal()" style="padding: 10px 24px;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script src="../scripts/toast.js"></script>
    <script src="../scripts/sidebar.js"></script>
    <script src="../scripts/role-manager.js"></script>
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/api.js"></script>
    <script>
        // Initialize Auth
        auth.initAuth();
        const canManage = auth.hasRole('Admin', 'HR');

        let employees = [];
        let salaries = [];
        let salaryGroups = [];
        let designations = [];
        let departments = [];
        let filteredEmployees = [];

        // Check if we're viewing a specific employee (from profile page)
        const urlParams = new URLSearchParams(window.location.search);
        const specificEmployeeId = urlParams.get('employeeId');

        // Load all data
        async function loadData() {
            try {
                // Load employees
                const empResponse = await endpoints.employees.getAll();
                employees = empResponse.data || [];

                // If viewing specific employee, filter to only that employee
                if (specificEmployeeId) {
                    employees = employees.filter(emp => emp.EmployeeId == specificEmployeeId);
                    
                    // Hide filters and export button when viewing single employee
                    const filterBar = document.querySelector('.filter-bar');
                    const exportBtn = document.querySelector('.btn-outline');
                    if (filterBar) filterBar.style.display = 'none';
                    if (exportBtn) exportBtn.style.display = 'none';
                }

                // Load salaries
                const salResponse = await endpoints.salary.getAll();
                salaries = salResponse.data || [];

                // Load salary groups
                const groupsResponse = await endpoints.salary.getGroups();
                salaryGroups = groupsResponse.data || [];

                // Load designations
                const desResponse = await endpoints.designations.getAll();
                designations = desResponse.data || [];

                // Load departments
                const deptResponse = await endpoints.departments.getAll();
                departments = deptResponse.data || [];

                // Populate filters (only if not viewing specific employee)
                if (!specificEmployeeId) {
                    populateFilters();
                }

                // Render table
                filteredEmployees = [...employees];
                renderTable();
            } catch (error) {
                console.error('Error loading data:', error);
                utils.showAlert('Failed to load data', 'error');
            }
        }

        // Populate filter dropdowns
        function populateFilters() {
            const desSelect = document.getElementById('filterDesignation');
            const deptSelect = document.getElementById('filterDepartment');

            desSelect.innerHTML = '<option value="">All</option>' + 
                designations.map(d => `<option value="${d.DesignationId}">${d.DesignationName}</option>`).join('');

            deptSelect.innerHTML = '<option value="">All</option>' + 
                departments.map(d => `<option value="${d.DepartmentId}">${d.DepartmentName}</option>`).join('');
        }

        // Apply filters
        function applyFilters() {
            const desFilter = document.getElementById('filterDesignation').value;
            const deptFilter = document.getElementById('filterDepartment').value;
            const searchText = document.getElementById('searchBox').value.toLowerCase();

            filteredEmployees = employees.filter(emp => {
                const matchesDes = !desFilter || emp.DesignationId == desFilter;
                const matchesDept = !deptFilter || emp.DepartmentId == deptFilter;
                const matchesSearch = !searchText || 
                    emp.FirstName.toLowerCase().includes(searchText) ||
                    emp.LastName.toLowerCase().includes(searchText) ||
                    emp.EmployeeCode.toLowerCase().includes(searchText);

                return matchesDes && matchesDept && matchesSearch;
            });

            renderTable();
        }

        // Render salary table
        function renderTable() {
            const tbody = document.getElementById('salaryTableBody');

            if (filteredEmployees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No employees found</td></tr>';
                return;
            }

            tbody.innerHTML = filteredEmployees.map(emp => {
                const salary = salaries.find(s => s.EmployeeId === emp.EmployeeId && s.IsActive);
                const initials = (emp.FirstName[0] + emp.LastName[0]).toUpperCase();

                return `
                <tr>
                    <td>
                        <div class="employee-info">
                            <div class="employee-avatar">${initials}</div>
                            <div class="employee-details">
                                <div class="employee-name">${emp.FirstName} ${emp.LastName}</div>
                                <div class="employee-designation">${emp.DesignationName || 'N/A'}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <select class="inline-select" ${!canManage ? 'disabled' : ''} 
                                onchange="updateSalaryField(${emp.EmployeeId}, 'salaryCycle', this.value)">
                            <option value="Monthly" ${salary?.SalaryCycle === 'Monthly' ? 'selected' : ''}>Monthly</option>
                            <option value="Weekly" ${salary?.SalaryCycle === 'Weekly' ? 'selected' : ''}>Weekly</option>
                            <option value="Bi-Weekly" ${salary?.SalaryCycle === 'Bi-Weekly' ? 'selected' : ''}>Bi-Weekly</option>
                            <option value="Annual" ${salary?.SalaryCycle === 'Annual' ? 'selected' : ''}>Annual</option>
                        </select>
                    </td>
                    <td>
                        <select class="inline-select" ${!canManage ? 'disabled' : ''}
                                onchange="updateSalaryField(${emp.EmployeeId}, 'salaryGroup', this.value)">
                            <option value="">-- Select --</option>
                            ${salaryGroups.map(g => 
                                `<option value="${g.SalaryGroupId}" ${salary?.SalaryGroupId == g.SalaryGroupId ? 'selected' : ''}>${g.GroupName}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td>
                        <label class="toggle-switch">
                            <input type="checkbox" ${salary?.AllowPayrollGenerate ? 'checked' : ''} ${!canManage ? 'disabled' : ''}
                                   onchange="updateSalaryField(${emp.EmployeeId}, 'allowPayroll', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </td>
                    <td>
                        <input type="number" class="inline-input" 
                               value="${salary?.NetSalaryMonthly || ''}" 
                               placeholder="--"
                               ${!canManage ? 'disabled' : ''}
                               onblur="updateSalaryField(${emp.EmployeeId}, 'netSalary', this.value)">
                    </td>
                    <td>
                        ${canManage ? `<button class="add-salary-btn" onclick="openSalaryModal(${emp.EmployeeId})" title="Add/Edit Salary">+</button>` : '-'}
                    </td>
                </tr>
                `;
            }).join('');
        }

        // Update salary field inline
        async function updateSalaryField(employeeId, field, value) {
            if (!canManage) return;

            try {
                let salary = salaries.find(s => s.EmployeeId === employeeId && s.IsActive);

                if (!salary) {
                    // Create new salary record with default values
                    const data = {
                        employeeId: employeeId,
                        baseSalary: field === 'netSalary' && value ? parseFloat(value) * 12 : 36000, // Default annual salary
                        salaryCycle: field === 'salaryCycle' ? value : 'Monthly',
                        currency: 'USD',
                        allowPayrollGenerate: field === 'allowPayroll' ? value : false,
                        netSalaryMonthly: field === 'netSalary' ? (value || null) : null,
                        salaryGroupId: field === 'salaryGroup' ? (value || null) : null,
                        effectiveFrom: new Date().toISOString().split('T')[0],
                        effectiveTo: null
                    };

                    console.log('üîç Creating salary with data:', data);
                    console.log('‚úÖ Fix is loaded! (v2)');
                    await endpoints.salary.create(data);
                } else {
                    // Update existing salary
                    const updateData = {
                        baseSalary: salary.BaseSalary,
                        salaryCycle: field === 'salaryCycle' ? value : salary.SalaryCycle,
                        currency: salary.Currency,
                        allowPayrollGenerate: field === 'allowPayroll' ? value : salary.AllowPayrollGenerate,
                        netSalaryMonthly: field === 'netSalary' ? (value || null) : salary.NetSalaryMonthly,
                        salaryGroupId: field === 'salaryGroup' ? (value || null) : salary.SalaryGroupId,
                        effectiveFrom: salary.EffectiveFrom,
                        effectiveTo: salary.EffectiveTo
                    };

                    await endpoints.salary.update(salary.EmployeeSalaryId, updateData);
                }

                // Reload salaries
                const response = await endpoints.salary.getAll();
                salaries = response.data || [];
                renderTable();

                utils.showAlert('Salary updated successfully', 'success');
            } catch (error) {
                console.error('Error updating salary:', error);
                utils.showAlert('Failed to update salary', 'error');
                renderTable(); // Revert changes
            }
        }

        // Open salary modal
        function openSalaryModal(employeeId) {
            const employee = employees.find(e => e.EmployeeId === employeeId);
            const salary = salaries.find(s => s.EmployeeId === employeeId && s.IsActive);

            document.getElementById('modalTitle').textContent = salary ? 'Edit Salary' : 'Add Salary';
            document.getElementById('employeeSalaryId').value = salary?.EmployeeSalaryId || '';
            document.getElementById('modalEmployeeId').value = employeeId;
            
            // Set employee details with avatar
            const initials = (employee.FirstName[0] + employee.LastName[0]).toUpperCase();
            document.getElementById('modalEmployeeAvatar').textContent = initials;
            document.getElementById('modalEmployeeName').textContent = `${employee.FirstName} ${employee.LastName}`;
            document.getElementById('modalEmployeeDesignation').textContent = employee.DesignationName || 'Employee';
            
            // Set employee role badge
            const roleElement = document.getElementById('modalEmployeeRole');
            const userRole = employee.Role || 'Employee'; // Get role from employee data
            roleElement.textContent = userRole;
            roleElement.className = `role-badge-small ${userRole.toLowerCase()}`;

            if (salary) {
                // Calculate annual CTC from base salary (assuming base salary is annual)
                const annualCTC = salary.BaseSalary || 0;
                document.getElementById('annualCTC').value = annualCTC;
                
                // Set hidden fields
                document.getElementById('effectiveFrom').value = salary.EffectiveFrom.split('T')[0];
                document.getElementById('currency').value = salary.Currency;
                document.getElementById('salaryCycle').value = salary.SalaryCycle;
                
                // Calculate components
                calculateSalaryComponents();
            } else {
                // Reset form for new salary
                document.getElementById('annualCTC').value = '';
                document.getElementById('basicSalaryPercent').value = '50';
                document.getElementById('effectiveFrom').value = new Date().toISOString().split('T')[0];
                document.getElementById('currency').value = 'USD';
                document.getElementById('salaryCycle').value = 'Monthly';
                
                // Reset calculations
                document.getElementById('basicSalaryMonthly').textContent = '0.00';
                document.getElementById('basicSalaryAnnual').textContent = '0.00';
                document.getElementById('specialAllowanceMonthly').textContent = '0.00';
                document.getElementById('specialAllowanceAnnual').textContent = '0.00';
                document.getElementById('totalCostMonthly').textContent = '0.00';
                document.getElementById('totalCostAnnual').textContent = '0.00';
            }

            document.getElementById('salaryModal').classList.add('active');
        }

        // Calculate salary components based on CTC
        function calculateSalaryComponents() {
            const annualCTC = parseFloat(document.getElementById('annualCTC').value) || 0;
            const basicPercent = parseFloat(document.getElementById('basicSalaryPercent').value) || 0;

            // Calculate basic salary
            const basicSalaryAnnual = (annualCTC * basicPercent) / 100;
            const basicSalaryMonthly = basicSalaryAnnual / 12;

            // Calculate special allowance (remaining amount)
            const specialAllowanceAnnual = annualCTC - basicSalaryAnnual;
            const specialAllowanceMonthly = specialAllowanceAnnual / 12;

            // Update display
            document.getElementById('basicSalaryMonthly').textContent = basicSalaryMonthly.toFixed(2);
            document.getElementById('basicSalaryAnnual').textContent = basicSalaryAnnual.toFixed(2);
            document.getElementById('specialAllowanceMonthly').textContent = specialAllowanceMonthly.toFixed(2);
            document.getElementById('specialAllowanceAnnual').textContent = specialAllowanceAnnual.toFixed(2);

            // Update cost summary
            const monthlyCost = annualCTC / 12;
            document.getElementById('totalCostMonthly').textContent = monthlyCost.toFixed(2);
            document.getElementById('totalCostAnnual').textContent = annualCTC.toFixed(2);

            // Update hidden fields for backend
            document.getElementById('baseSalary').value = annualCTC; // Store annual CTC as base salary
            document.getElementById('netSalaryMonthly').value = monthlyCost.toFixed(2);
        }

        

        function closeSalaryModal() {
            document.getElementById('salaryModal').classList.remove('active');
        }

        // Save salary
        async function saveSalary() {
            // Validate Annual CTC is entered
            const annualCTC = parseFloat(document.getElementById('annualCTC').value);
            if (!annualCTC || annualCTC <= 0) {
                utils.showAlert('Please enter a valid Annual CTC', 'error');
                return;
            }

            // Ensure calculations are up to date
            calculateSalaryComponents();

            const salaryId = document.getElementById('employeeSalaryId').value;
            const employeeId = parseInt(document.getElementById('modalEmployeeId').value);
            
            // Get values from hidden fields (populated by calculateSalaryComponents)
            const baseSalary = parseFloat(document.getElementById('baseSalary').value);
            const netSalaryMonthly = parseFloat(document.getElementById('netSalaryMonthly').value);
            const effectiveFrom = document.getElementById('effectiveFrom').value;
            
            if (!effectiveFrom) {
                utils.showAlert('Effective date is required', 'error');
                return;
            }

            const data = {
                employeeId: employeeId,
                baseSalary: baseSalary,
                salaryCycle: document.getElementById('salaryCycle').value,
                currency: document.getElementById('currency').value,
                salaryGroupId: null, // Not used in new interface
                netSalaryMonthly: netSalaryMonthly,
                effectiveFrom: effectiveFrom,
                effectiveTo: null,
                allowPayrollGenerate: true // Always true in new interface
            };

            try {
                if (salaryId) {
                    await endpoints.salary.update(salaryId, data);
                    utils.showAlert('Salary updated successfully', 'success');
                } else {
                    await endpoints.salary.create(data);
                    utils.showAlert('Salary created successfully', 'success');
                }

                closeSalaryModal();
                
                // Reload salaries
                const response = await endpoints.salary.getAll();
                salaries = response.data || [];
                renderTable();
            } catch (error) {
                console.error('Error saving salary:', error);
                utils.showAlert(error.message || 'Failed to save salary', 'error');
            }
        }

        // Export salaries
        function exportSalaries() {
            const csv = [
                ['Employee Code', 'Name', 'Designation', 'Department', 'Salary Cycle', 'Salary Group', 'Base Salary', 'Net Salary', 'Allow Payroll', 'Effective From'].join(','),
                ...filteredEmployees.map(emp => {
                    const salary = salaries.find(s => s.EmployeeId === emp.EmployeeId && s.IsActive);
                    return [
                        emp.EmployeeCode,
                        `"${emp.FirstName} ${emp.LastName}"`,
                        emp.DesignationName || '',
                        emp.DepartmentName || '',
                        salary?.SalaryCycle || '',
                        salary?.SalaryGroupName || '',
                        salary?.BaseSalary || '',
                        salary?.NetSalaryMonthly || '',
                        salary?.AllowPayrollGenerate ? 'Yes' : 'No',
                        salary?.EffectiveFrom ? salary.EffectiveFrom.split('T')[0] : ''
                    ].join(',');
                })
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `employee-salaries-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            utils.showAlert('Salaries exported successfully', 'success');
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
